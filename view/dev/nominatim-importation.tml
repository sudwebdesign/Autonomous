<?php
use model\R;
set_time_limit(0);
ob_implicit_flush(true);
ob_end_flush();
$URL =	'http://nominatim.openstreetmap.org/search?city=%s&department=%s&country=France&polygon=1&format=json';
?>
<pre>
Nominatim Importation Communes of <?=model::DEFAULT_DEPARTEMENT_CODE?>	
<?php
R::debug();
foreach(model::table('communes',array('select'=>'communes.id,communes.label','join'=>"JOIN departements ON departements.id=communes.departements_id AND departements.code=?"),array(model::DEFAULT_DEPARTEMENT_CODE)) as $id=>$commune){
	$url = sprintf($URL,urlencode($commune['label']),urlencode('Pyrénées-Orientale'));
	echo $url;
	if(($json=json_decode(file_get_contents($url),true))&&isset($json[0]['polygonpoints'])){
		$polygon = '';
		foreach($json[0]['polygonpoints'] as $point)
			$polygon .= $point[0].' '.$point[1].',';
		$polygon = substr($polygon,0,-1);
		if(R::exec('UPDATE communes SET polygon = ? WHERE id=?',array('PolygonFromText("POLYGON(('.$polygon.'))")',$commune['id'])))
			echo 'OK';
		else
			echo 'ERROR DB';
	}
	else
		echo ' ERROR OSM NOT FOUND';
	echo "\r\n";
}
	
?>
</pre>
