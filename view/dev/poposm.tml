<present: />
<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="utf-8"/>
		<script>
			L.Icon.Default.imagePath = 'img';
			var mappop, searchBB ;

			$(function() {
				
				$('#popupTemplate').hide();
				
				mappop = L.map('mappop');

				var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
				var osmAttrib='mappop data © OpenStreetmap contributors';
				var osm = new L.TileLayer(osmUrl, {minZoom: 1, maxZoom: 18, attribution: osmAttrib});
				mappop.addLayer(osm);
				mappop.setView([42.666, 2.902], 11);
				var m = L.marker([42.70477, 2.93989], {toto: 'Toto habite ici'}).on('click', onMarkerClick).addTo(mappop);
				m = L.marker([42.62559, 2.86771], {toto: 'Emmaus (Var dans popup.js) '}).on('click', onMarkerClick).addTo(mappop);
				m.on('click', onMarkerClick);

			});
			
			function onMarkerClick(e)
			{
				var m = e.target ;
				
				idpop = m.getLatLng().lat+'-'+m.getLatLng().lng;

				$('#popupTemplate .toto').html(m.options.toto);
				$('#popupTemplate .search').attr('onclick',
					'searchOsm('+m.getLatLng().lat+','+m.getLatLng().lng+',"popupInstance'+idpop+'"'+')');

				t = '<div id="popupInstance'+idpop+'">' + $('#popupTemplate').html() + '</div>';
				m.bindPopup(t).openPopup();

			}

			function searchOsm(lat,lng, popupInstanceId)
			{
				console.log('searchOsm()');
				
				var d = $('#'+popupInstanceId+' .distance').val();
				console.log(d);
				var p1 = moveCoordinatesByMetres([lat,lng], [-1000,-1000]);
				var p2 = moveCoordinatesByMetres([lat,lng], [1000,1000]);

				var bounds = [p1, p2];

				if( searchBB != null )
					mappop.removeLayer(searchBB);
				// create an orange rectangle
				searchBB = L.rectangle(bounds, {color: "#ff7800", weight: 1}).addTo(mappop);

			}

			function moveCoordinatesByMetres (latLng, m) {
				var pi = Math.PI;
				//Earth’s radius, sphere
				var R = 6378137;
				// latLng to transform
				var lat = latLng[0] || latLng.lat;
				var lng = latLng[1] || latLng.lng;
				//Coordinate offsets in radians
				var dLat = m[0] / R;
				var dLng = m[1] / ( R * Math.cos(pi * lat / 180) );
				//OffsetPosition, decimal degrees
				lat = lat + ( dLat * 180 / pi );
				lng = lng + ( dLng * 180 / pi );
				return [lat, lng];
			}
			
		</script>
		<style type="text/css">
			#mappop {
				width: 760px;
				height: 400px;
			}
		</style>
	</head>
	<body>
		<div id="mappop"></div>
		<div id="popupTemplate">
			<strong class="text-success">Toto habite ici</strong>
			<br/>
			<span class="toto"></span>
			<br/>
			<input type="text" class="distance" name="distance" />
			<br/>
			<a class="btn search" href="javascript:void(0)" onclick="">search osm</a>
		</div>
		
	</body>
</html>
